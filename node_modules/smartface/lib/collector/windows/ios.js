const fs = require('fs');
const _ = require('underscore');
const TAG = require('../tag');
const Parser = require('../../xmltojson');
const utility = require('../../utility');

const SFPX = TAG.SFPX;
const LICENSE = TAG.LICENSE;

function configUpdateFromArgs(config, args) {
	var input = config.iosConfig.input;
	var output = config.iosConfig.output;
	const root = config.user.project.root;
	utility.throwsNoSuchDir(root);
	_.extend(input, {
		"assets": root + '/Assets',
		"scripts": root + '/Scripts',
		"images": root + '/resources/Images/ios',
		"playerZip": args.PLAYER_ZIP,
		"plugins": args.iOS_PLUGINS
	});
	if (args.OUTPUT_ZIP === 'Smartface Demo.zip') {
		const appName = args.OUTPUT_ZIP.replace(/Smartface Demo.zip/gm, input.license.name + '.zip');
		if (process.env.USERPROFILE) {
			getDocumentsPath(function(data){
				 output.outputZip = data+ input.license.name + '/iOS/' + appName;
			});
		} else {
			output.outputZip = utility.convertAbsolute.convert('Smartface/Published Projects/' +
				input.license.name +
				'/iOS/' + appName);
		}
	} else {
		output.outputZip = args.OUTPUT_ZIP;
	}
}

// application license from license file.
function configUpdateFromLicense(config, licenseFilePath) {
	utility.throwsNoSuchFile(licenseFilePath);
	const licenseObj = new Parser().parse(licenseFilePath);
	const appLicenseObj = licenseObj.findObjectHasTargetObject(LICENSE.APP_PACKAGE_LICENSE_TAG, LICENSE.PACKAGE_TYPE_TAG, 'iOS');
	var input = config.iosConfig.input;
	_.extend(input.license, {
		"data": appLicenseObj.createXmlString(),
		"type": appLicenseObj.findObject(LICENSE.LICENSE_TYPE_TAG).getContent(),
		"name": appLicenseObj.findObject(LICENSE.LICENSE_NAME_TAG).getContent().replace('&amp;', '&')
	});
	var infoPlist = input.infoPlist;
	const packageName = appLicenseObj.findObject(LICENSE.PACKAGE_NAME_TAG).getContent();
	const temp = packageName.split('.');
	const productNameFromTemp = temp[temp.length - 1];
	const productName = (productNameFromTemp === 'SmartfaceDemo') ? 'Smartface-Demo' : productNameFromTemp;
	_.extend(infoPlist, {
		"appNameShort": infoPlist.appName.substr(0, 16),
		"packageName": packageName,
		"productName": productName,
		"appVersion": config.config2.appVersion
	});
}

function configUpdateFromSfpx(config) {
	utility.throwsNoSuchFile(config.user.project.sfpx);
	const sfpxObj = new Parser().parse(config.user.project.sfpx); // the most commonly used object.
	var input = config.iosConfig.input;
	const IOSKeystoreObj = sfpxObj.findObject(SFPX.IOS_KEYSTORE_TAG);
	_.extend(input, {
		"urlIdentifier": IOSKeystoreObj.getAttribute(SFPX.ATTR_IOS_URL_IDENTIFIER),
		"urlSchemes": IOSKeystoreObj.getAttribute(SFPX.ATRR_IOS_URL_SCHEMES)
	});
	input.infoPlist.appName = sfpxObj.findObject(SFPX.APP_NAME_TAG).getAttribute(SFPX.ATTR_APP_NAME_TAG);
}

function getDocumentsPath(callback){
	try{
		var execSync = require('child_process').execSync('reg query "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders" /v "Personal"');
		var streamOut = execSync.toString().trim();
		var path = streamOut.split('\n')[1];
		path = path.trim();
		path = path.substring(path.indexOf('REG_SZ')+6,path.length);
		path = path.trim();
		callback(path+'/Smartface/Published Projects/');
	}
	catch(e){
		callback(process.env.USERPROFILE +'/Documents/Smartface/Published Projects/');
	}
}

module.exports = {
	configUpdateFromSfpx: configUpdateFromSfpx,
	configUpdateFromLicense: configUpdateFromLicense,
	configUpdateFromArgs: configUpdateFromArgs
};