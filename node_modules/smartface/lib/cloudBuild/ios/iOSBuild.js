const upload = require("../uploader");
const md5 = require("../fileService").md5;

function uploadForCloudBuild(_host, token, cloudBuildConfig) {
	var options = {
		host: _host,
		path: "/build",
		headers: {
			Authorization: token
		},
		method: "post",
		port: 8080
	};

	if (process.env.SMF_CBM_LINK) {
		cloudBuildConfig.config.logToConsole = true;
	}
	
	return md5(cloudBuildConfig.playerPath).then(hash => {
		cloudBuildConfig.config.playerHash = hash;
		var sources = [{
			"name": "contentZip",
			"path": cloudBuildConfig.contentZip
		}, {
			"name": "config",
			"value": JSON.stringify(cloudBuildConfig.config)
		}];

		return upload(sources, options);

	}, err => {
		throw err;
	});

}


module.exports = uploadForCloudBuild;
