const fileService = require("../fileService");
const SERVER_CONFIG = require("../../configuration").SERVER;

const forge = require("node-forge");

//download keystore and its passwords.
function downloadKeyStoreFile(cldConfig) {
  return fileService
    .downloadFile(getOptionsFromConfig(cldConfig), cldConfig.keystoreFile)
    .then(res => {
      return {
        keystorePass: forge.util.decode64(res["keystorepassword"]),
        keyPass: forge.util.decode64(res["keypassword"])
      };
    }, err => {
      throw err;
    });
}

function getOptionsFromConfig(config) {

  var options = {
    host: SERVER_CONFIG.portalapi,
    path: "/api/v1/build/keystores/",
    headers: {
      "Authorization": config.authorization
    },
  };
  options.path += config.id;
  return options;
}

module.exports = {
  downloadKeyStoreFile: downloadKeyStoreFile
};
